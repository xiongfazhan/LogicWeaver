# LogicWeaver 产品需求文档 (PRD) v3.0

> 业务逻辑构建平台 —— Data Flow Specification 生成器

---

## 核心定位

**"教-译-筑"三阶解耦架构**

将业务专家的经验，翻译成开发人员可直接实现的数据契约。

| 角色 | 职责 | 输入/输出 |
|------|------|----------|
| 上游：业务专家 | 只负责"教" | 自然语言 + 图片/语音 |
| 中游：LogicWeaver | 负责"译" | Data Flow Specification |
| 下游：开发人员 | 负责"筑" | 自由选择技术实现 |

---

## 核心理念变更（v2.0 → v3.0）

### 从"技术指令"到"数据契约"

| 维度 | v2.0（旧） | v3.0（新） |
|------|-----------|-----------|
| 输出内容 | 技术实现指令（用 YOLO/GPT） | 纯数据契约（Input/Output） |
| 决策权 | 平台指定技术方案 | 开发人员自由选择 |
| 耦合度 | 与具体技术强耦合 | 完全解耦 |
| 核心价值 | 技术建议 | 数据流规格说明书 |

### 核心原则

**只定义"要什么"，不管"怎么做"。**

- ❌ 错误："用 YOLOv8 检测人数"
- ✅ 正确："Input: 一张图片；Output: person_count (int)"

---

## 第一阶段：采集端 (Builder)

### 用户角色
业务专家（老师傅、资深法务、金牌客服等）

### 交互逻辑
简化的步骤采集流程，每个步骤只需填写：

| 字段 | 说明 | 示例 |
|------|------|------|
| 步骤名称 | 简短描述 | "拍照"、"数人"、"写表格" |
| 上下文描述 | 自然语言描述这一步做什么 | "拍一张办公室照片，数一下有几个人" |
| 参考材料 | 可选：图片/文本/语音 | 上传示例图片 |

### 页面布局

```
┌─────────────────────────────────────────────────────────┐
│  ◀ 返回                    工作流名称                   │
├──────────────┬──────────────────────────────────────────┤
│              │                                          │
│  步骤列表     │        步骤采集区                        │
│              │                                          │
│  ○ 步骤 1    │   ┌────────────────────────────────┐    │
│  ○ 步骤 2    │   │  步骤名称: [输入框]            │    │
│  ○ 步骤 3    │   │                                │    │
│              │   │  上下文描述: [文本框]          │    │
│  + 添加步骤   │   │                                │    │
│              │   │  参考材料: [上传区域]          │    │
│              │   └────────────────────────────────┘    │
│              │                                          │
│              │            [上一步] [下一步]             │
├──────────────┴──────────────────────────────────────────┤
│                    [结束采集并去复核]                    │
└─────────────────────────────────────────────────────────┘
```

---

## 第二阶段：AI 分析

### 触发时机
用户点击"结束采集并去复核"

### 分析流程

```
步骤 1 分析
   │
   ↓ 输出变量传递
   │
步骤 2 分析（接收 step1.outputs 作为上下文）
   │
   ↓ 输出变量传递
   │
步骤 N 分析
   │
   ↓
完成，跳转复核页面
```

### 上下文感知

**核心特性**：分析当前步骤时，自动将前序步骤的 Output 作为上下文传递给 AI。

**解决的问题**：
- 步骤 1 输出 `office_image`
- 步骤 2 输入必须使用 `office_image`（而非另起名字 `image_input`）

### 输出格式

```json
{
  "contract": {
    "step_id": 1,
    "step_name": "统计人数",
    "business_intent": "统计图片中的人数",
    "inputs": [
      {
        "name": "office_image",
        "type": "image",
        "description": "上一步拍摄的办公室照片",
        "required": true
      }
    ],
    "outputs": [
      {
        "name": "person_count",
        "type": "int",
        "description": "图片中识别到的人数",
        "required": true
      }
    ],
    "acceptance_criteria": "人数统计误差不超过1人",
    "notes": "开发人员可自由选择实现方式"
  },
  "confidence_score": 0.95
}
```

---

## 第三阶段：复核端 (Review)

### 布局设计：左右对齐

```
┌─────────────────────────────────────────────────────────┐
│  ◀ 返回编辑        复核: 工作流名称        [2 个步骤]   │
├─────────────────────────┬───────────────────────────────┤
│ 📝 源输入（用户填写）    │ 📋 Data Flow（AI 生成）       │
├─────────────────────────┼───────────────────────────────┤
│                         │                               │
│ 步骤 1: 拍照            │ 📋 采集办公室现场照片          │
│ ┌─────────────────────┐ │ In: (无)                     │
│ │     [示例图片]       │ │ Out: office_image (image)   │
│ └─────────────────────┘ │ ✓ 照片清晰                   │
│ 描述：记录人员数量       │                               │
│                         │                               │
├─────────────────────────┼───────────────────────────────┤
│                         │                               │
│ 步骤 2: 数人            │ 📋 统计图片中的人数            │
│ 描述：统计办公室人数     │ In: office_image (image)     │
│                         │ Out: person_count (int)      │
│                         │ ✓ 误差不超过1人              │
│                         │                               │
├─────────────────────────┴───────────────────────────────┤
│           [2 个步骤已分析]        [生成流程图 →]         │
└─────────────────────────────────────────────────────────┘
```

### 交互特性
- 左右步骤一一对齐，方便逐步对照
- 图片点击可放大预览
- 固定表头滚动

---

## 第四阶段：流程图 (Flowchart)

### 节点设计

```
┌───────────────────────────┐
│   [缩略图或序号]           │
├───────────────────────────┤
│ 步骤 1: 拍照               │
│ 📋 采集办公室现场照片       │
│ In: - → Out: office_image │
│ ✓ 已完成                   │
└───────────────────────────┘
          │
          ↓
┌───────────────────────────┐
│ 步骤 2: 数人               │
│ 📋 统计图片中的人数         │
│ In: office_image → Out: person_count │
│ ✓ 已完成                   │
└───────────────────────────┘
```

### 节点信息
- 步骤名称
- 业务意图（一句话）
- Inputs → Outputs
- 完成状态

---

## 数据类型规范

| 类型 | 说明 | 示例 |
|------|------|------|
| `string` | 文本 | "张三" |
| `int` | 整数 | 5 |
| `float` | 浮点数 | 0.95 |
| `bool` | 布尔值 | true |
| `image` | 图片 | URL 或 base64 |
| `file` | 文件 | "report.xlsx" |
| `list[string]` | 字符串列表 | ["a", "b"] |
| `dict` | 字典/对象 | {"key": "value"} |

---

## 技术架构

### 前端
- **框架**：React + TypeScript + Vite
- **UI 库**：Tailwind CSS + Shadcn/UI
- **流程图**：ReactFlow
- **状态管理**：Zustand + React Query

### 后端
- **框架**：FastAPI + Python
- **数据库**：PostgreSQL + SQLAlchemy
- **LLM**：OpenAI 兼容 API（ChatGLM/GPT-4 等）

### 核心文件
| 文件 | 作用 |
|------|------|
| `ai_analysis.py` | AI 分析服务，生成数据契约 |
| `llm.py` | LLM 调用封装 |
| `useAnalysis.ts` | 前端分析 hooks |
| `Review.tsx` | 复核页面 |
| `StepNode.tsx` | 流程图节点 |

---

## 设计原则

1. **只定义契约，不定技术** - 绝不提及 YOLO/GPT/Python 等
2. **变量名用英文蛇形命名法** - 如 `person_count`, `office_image`
3. **上下游衔接** - 下一步的 input 应能接上一步的 output
4. **业务意图清晰** - 用一句话说清楚这一步要做什么
5. **左右对齐** - 复核页面源数据与数据契约一一对应

---

## 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v1.0 | - | 初版，4步微循环采集 |
| v2.0 | - | 增加 Few-Shot 软规则、路由分支 |
| v3.0 | 2024-12 | **范式转变**：从"技术指令"到"数据契约"，实现教-译-筑解耦 |
